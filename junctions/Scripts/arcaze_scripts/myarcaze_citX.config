require "arcaze"

for i, dev in ipairs(ALL_HID_DEVICES) do
	if (dev.vendor_id == 5776) and (dev.product_id == 65043) then
		if dev.product_string == "B2_AP_PNL" then
			my_arcaze_board = hid_open_path(dev.path)
		else
			logMsg("FlyWithLua Warning: Unknown / New Arcaze device found!")
		end
	end
end


if my_arcaze_board == nil then
	logMsg("Arcaze Board 1 has not been found!")


else

	print("Aircraft Script for Laminar CitationX ( ",  AIRCRAFT_FILENAME, " ) has been loaded")
	
	BOARD_A01=0
	BOARD_A02=1
	BOARD_A03=2
	BOARD_A04=3
	BOARD_A05=4
	BOARD_A06=5
	BOARD_A07=6
	BOARD_A08=7
	BOARD_A09=8
	BOARD_A10=9
	BOARD_A11=10
	BOARD_A12=11
	BOARD_A13=12
	BOARD_A14=13
	BOARD_A15=14
	BOARD_A16=15
	BOARD_A17=16
	BOARD_A18=17
	BOARD_A19=18
	BOARD_A20=19
	BOARD_B01=20
	BOARD_B02=21
	BOARD_B03=22
	BOARD_B04=23
	BOARD_B05=24
	BOARD_B06=25
	BOARD_B07=26
	BOARD_B08=27
	BOARD_B09=28
	BOARD_B10=29
	BOARD_B11=30
	BOARD_B12=31
	BOARD_B13=32
	BOARD_B14=33
	BOARD_B15=34
	BOARD_B16=35
	BOARD_B17=36
	BOARD_B18=37
	BOARD_B19=38
	BOARD_B20=39
	
	dataref("master_warn_citX", "laminar/CitX/annunciators/master_warning", "readable")
	dataref("master_caution_citX", "laminar/CitX/annunciators/master_caution", "readable")	
	dataref("parking_break_citX", "sim/cockpit2/controls/parking_brake_ratio", "readable")	
	dataref("vnav", "laminar/CitX/autopilot/vnav_mode_on", "readable")
	dataref("lnav", "laminar/CitX/autopilot/nav_mode_on", "readable")
	dataref("cmd_a", "laminar/CitX/autopilot/left_ap", "readable")
	dataref("yd", "laminar/CitX/autopilot/left_yd", "readable")
	dataref("speed", "laminar/CitX/autopilot/cngovr_mode_on", "readable")
	dataref("lvl_chg", "laminar/CitX/autopilot/flc_mode_on", "readable")
	dataref("vs", "laminar/CitX/autopilot/vs_mode_on", "readable")
	dataref("alt_hld", "laminar/CitX/autopilot/alt_mode_on", "readable")
	dataref("app", "laminar/CitX/autopilot/app_mode_on", "readable")
	dataref("hdg_sel", "laminar/CitX/autopilot/hdg_mode_on", "readable")
    dataref("standby", "laminar/CitX/autopilot/stby_mode_on", "readable")

	
	local clock = os.clock
	function sleep(n)  -- seconds
	  local t0 = clock()
	  while clock() - t0 <= n do end
	end
		
	-------------------------------------------------------------------------------------------	
	--//----LED TEST---------------------------------------------------------------------------
	-------------------------------------------------------------------------------------------		
		
		
	function testLEDs(state)
		
		arcaze.set_pin(my_arcaze_board,BOARD_B03,state)	
		arcaze.set_pin(my_arcaze_board,BOARD_B04,state)
		arcaze.set_pin(my_arcaze_board,BOARD_B05,state)
		arcaze.set_pin(my_arcaze_board,BOARD_B06,state)
		arcaze.set_pin(my_arcaze_board,BOARD_B07,state)
		arcaze.set_pin(my_arcaze_board,BOARD_B08,state)
		arcaze.set_pin(my_arcaze_board,BOARD_B09,state)
		arcaze.set_pin(my_arcaze_board,BOARD_B10,state)
		arcaze.set_pin(my_arcaze_board,BOARD_B11,state)
		arcaze.set_pin(my_arcaze_board,BOARD_B12,state)
		arcaze.set_pin(my_arcaze_board,BOARD_B13,state)
		arcaze.set_pin(my_arcaze_board,BOARD_B14,state)
		arcaze.set_pin(my_arcaze_board,BOARD_B15,state)
		arcaze.set_pin(my_arcaze_board,BOARD_B16,state)
		arcaze.set_pin(my_arcaze_board,BOARD_B17,state)
		arcaze.set_pin(my_arcaze_board,BOARD_B18,state)
		arcaze.set_pin(my_arcaze_board,BOARD_B19,state)
		arcaze.set_pin(my_arcaze_board,BOARD_B20,state)
	
	end

-- TEST LEDs Start

	testLEDs(1)
	sleep(3)
	testLEDs(0)
	
-- TEST LEDs End


	-------------------------------------------------------------------------------------------	
	--//----SETTERS FOR LEDS AND BUTTON STATES-------------------------------------------------
	-------------------------------------------------------------------------------------------	


	function setMasterWarnLED()
					
		if (master_warn_citX > 0) then arcaze.set_pin(my_arcaze_board,BOARD_B03,1) end
		if (master_warn_citX == 0) then arcaze.set_pin(my_arcaze_board,BOARD_B03,0)	 end	
		
	end	
	
	function setMasterCautionLED()
					
		if (master_caution_citX > 0) then arcaze.set_pin(my_arcaze_board,BOARD_B04,1) end
		if (master_caution_citX == 0) then arcaze.set_pin(my_arcaze_board,BOARD_B04,0)	 end	
		
	end	
	

	function setParkingBreakLED()
		
		if (parking_break_citX == 0 or parking_break_citX == 1) then arcaze.set_pin(my_arcaze_board,BOARD_B05,parking_break_citX) end								

	end

	function setVnavLED()
		
		if (vnav > 0) then arcaze.set_pin(my_arcaze_board,BOARD_B07,1)	end							
		if (vnav == 0) then arcaze.set_pin(my_arcaze_board,BOARD_B07,0)	end			
		
	end

	function setLnavLED()
		
		if (lnav > 0) then arcaze.set_pin(my_arcaze_board,BOARD_B08,1)	end							
		if (lnav == 0) then arcaze.set_pin(my_arcaze_board,BOARD_B08,0)	end			
		
	end

	function setCMDaLED()
		
		if (cmd_a > 0) then arcaze.set_pin(my_arcaze_board,BOARD_B09,1)	end							
		if (cmd_a == 0) then arcaze.set_pin(my_arcaze_board,BOARD_B09,0) end								
		
	end

	function setYDLED()
		
		if (yd > 0) then arcaze.set_pin(my_arcaze_board,BOARD_B10,1) end							
		if (yd == 0) then arcaze.set_pin(my_arcaze_board,BOARD_B10,0) end						
		
	end

	function setSpeedLED()
		
		if (speed > 0) then arcaze.set_pin(my_arcaze_board,BOARD_B11,1) end							
		if (speed == 0) then arcaze.set_pin(my_arcaze_board,BOARD_B11,0) end								
		
	end

	function setLvlChgLED()
		
		if (lvl_chg > 0) then arcaze.set_pin(my_arcaze_board,BOARD_B12,1) end							
		if (lvl_chg == 0) then arcaze.set_pin(my_arcaze_board,BOARD_B12,0) end									
		
	end
	
	function setVsLED()
		
		if (vs > 0) then arcaze.set_pin(my_arcaze_board,BOARD_B20,1) end							
		if (vs == 0) then arcaze.set_pin(my_arcaze_board,BOARD_B20,0) end								
		
	end

	function setAltHldLED()
		
		if (alt_hld > 0) then arcaze.set_pin(my_arcaze_board,BOARD_B19,1) end							
		if (alt_hld == 0) then arcaze.set_pin(my_arcaze_board,BOARD_B19,0) end				
									
		
	end
	
	function setAppLED()
		
		if (app > 0) then arcaze.set_pin(my_arcaze_board,BOARD_B18,1) end							
		if (app == 0) then arcaze.set_pin(my_arcaze_board,BOARD_B18,0) end									
		
	end

	function setHdgSelLED()
		
		if (hdg_sel > 0) then arcaze.set_pin(my_arcaze_board,BOARD_B17,1) end							
		if (hdg_sel == 0) then arcaze.set_pin(my_arcaze_board,BOARD_B17,0) end				
		
	end
	
	function setSTBYLED()
		
		if (standby > 0) then arcaze.set_pin(my_arcaze_board,BOARD_B16,1) end							
		if (standby == 0) then arcaze.set_pin(my_arcaze_board,BOARD_B16,0) end	
		
	end
	
	
	--set LEDs
	do_every_frame("setMasterCautionLED()")
	do_every_frame("setMasterWarnLED()")
	do_every_frame("setParkingBreakLED()")
	do_every_frame("setVnavLED()")
	do_every_frame("setLnavLED()")
	do_every_frame("setCMDaLED()")
	do_every_frame("setYDLED()")
	do_every_frame("setSpeedLED()")
	do_every_frame("setLvlChgLED()")
	do_every_frame("setVsLED()")
	do_every_frame("setAltHldLED()")
	do_every_frame("setAppLED()")
	do_every_frame("setHdgSelLED()")
	do_every_frame("setSTBYLED()")
	
	--clear LEDs on exit
	do_on_exit("testLEDs(0)")

end